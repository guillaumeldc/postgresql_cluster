---
- name: remove_cluster.yml | Remove PostgreSQL HA Cluster
  hosts: postgres_cluster
  become: true
  pre_tasks:
    - name: Include main variables
      ansible.builtin.include_vars: "vars/main.yml"
    - name: Include OS-specific variables
      ansible.builtin.include_vars: "vars/{{ ansible_os_family }}.yml"
  tasks:
    - block:
        - name: Stop Patroni service
          ansible.builtin.service:
            name: patroni
            state: stopped
            enabled: false

        - name: Delete PostgreSQL database content
          ansible.builtin.file:
            path: "{{ postgresql_data_dir }}"
            state: absent
      when: remove_postgres | default(false) | bool
      ignore_errors: true

    - block:
        - name: Delete PgBackRest repository
          ansible.builtin.file:
            # path: pgbackrest_conf global repo1-path
            path: /var/lib/pgbackrest
            state: absent

        - name: Delete PgBackRest cron
          ansible.builtin.file:
            path: /etc/cron.d/pgbackrest
            state: absent
      when: pgbackrest_install | default(false) | bool
      ignore_errors: true

- name: remove_cluster.yml | Consul Cluster Play
  hosts: consul_instances
  become: true
  pre_tasks:
    - name: Include main variables
      ansible.builtin.include_vars: "vars/main.yml"
  tasks:
    - block:
        - name: Stop Consul service
          ansible.builtin.service:
            name: consul
            state: stopped
            enabled: false

        - name: Delete Consul content
          ansible.builtin.file:
            path: "{{ consul_data_path }}"
            state: absent

        - name: Delete Consul service
          ansible.builtin.file:
            path: /lib/systemd/system/consul.service
            state: absent
      when: remove_consul | default(false) | bool
      ignore_errors: true

- name: remove_cluster.yml | Etcd Cluster Play
  hosts: etcd_cluster
  become: true
  pre_tasks:
    - name: Include main variables
      ansible.builtin.include_vars: "vars/main.yml"
  tasks:
    - block:
        - name: Stop Etcd service
          ansible.builtin.service:
            name: etcd
            state: stopped
            enabled: false

        - name: Delete Etcd content
          ansible.builtin.file:
            path: "{{ etcd_data_dir }}/member"
            state: absent
      when: remove_etcd | default(false) | bool
      ignore_errors: true

- name: remove_cluster.yml | Remove PSQL Data
  hosts: postgres_cluster
  become: true
  pre_tasks:
    - name: Include main variables
      ansible.builtin.include_vars: "vars/main.yml"
  tasks:
    - block:
        - name: Remove existing PostgreSQL data directory
          ansible.builtin.file:
            path: /var/lib/postgresql/16/main
            state: absent
      when: remove_psql_data | default(false) | bool
      ignore_errors: true



- name: remove_cluster.yml | VIP Manager Cluster Play
  hosts: postgres_cluster
  become: true
  vars_files:
    - vars/main.yml
  tasks:
    - block:
        - name: Stop vip-manager service
          systemd:
            name: vip-manager
            state: stopped

        - name: Disable vip-manager service
          systemd:
            name: vip-manager
            enabled: no

        - name: Remove vip-manager executable
          file:
            path: "/usr/bin/vip-manager" # Adjust if your installation path is different
            state: absent

        - name: Remove vip-manager configuration
          file:
            path: "/etc/patroni/vip-manager.yml" # Adjust the path according to your setup
            state: absent

        - name: Remove vip-manager systemd service file
          file:
            path: "/etc/systemd/system/vip-manager.service"
            state: absent

        - name: Reload systemd daemon
          systemd:
            daemon_reload: yes